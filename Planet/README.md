## Архитектура проекта Planet (как ориентироваться в коде)

Проект организован так, чтобы любой новый функционал можно было быстро найти и доработать. Ниже описано, какие слои есть в приложении и куда смотреть для любой фичи.

### 1. Общий поток работы

1. **Запуск приложения**
   - Файл: `core/main.cpp`
   - Создаётся `QApplication`, настраивается формат OpenGL, создаётся и показывается `MainWindow`.

2. **Главное окно и панель настроек**
   - Файлы: `ui/MainWindow.*`, `ui/PlanetSettingsPanel.*`
   - `MainWindow`:
     - создаёт центральный OpenGL-виджет `HexSphereWidget`;
     - создаёт панель настроек (`PlanetSettingsPanel`) в доке;
     - соединяет сигналы панели (изменение генератора, параметров рельефа и т.п.) с методами центрального виджета.

3. **OpenGL-виджет планеты**
   - Файлы: `ui/HexSphereWidget.*`
   - Наследник `QOpenGLWidget`, отвечает за:
     - инициализацию контекста (`initializeGL`);
     - реакцию на изменение размера (`resizeGL`);
     - отрисовку кадра (`paintGL`);
     - приём Qt-событий (`mouse*`, `key*`, `wheel`) и их передачу дальше.
   - Внутри хранит:
     - `CameraController` — управление камерой;
     - `InputController` — вся логика ввода, сцены и рендера.

4. **Контроллер ввода и сцены**
   - Файлы: `controllers/InputController.*`
   - Центральное место, где сходится всё:
     - инициализирует `HexSphereRenderer` и OpenGL-функции;
     - создаёт начальные сущности (например, «исследователь» на поверхности);
     - хранит:
       - `HexSphereSceneController` — состояние планеты и её меши;
       - `ecs::ComponentStorage` — сущности и компоненты (позиция, коллайдеры, меши);
       - `PerformanceStats` — статистика рендеринга;
       - настройки загрузки буферов.
   - Обрабатывает ввод:
     - клики мышью, перемещение, колесо, клавиши;
     - вычисляет луч от камеры под курсором;
     - выбирает ячейки планеты и сущности;
     - меняет высоту, биомы, выделение, путь;
     - двигает выбранную сущность по поверхности.
   - Управляет перестройкой сцены:
     - `rebuildModel()` — пересобирает модель планеты;
     - `uploadBuffers()` — отправляет данные на GPU;
     - `render()` — собирает `RenderGraph`, `RenderCamera`, `SceneLighting` и вызывает `HexSphereRenderer`.

5. **Контроллер планеты**
   - Файлы: `controllers/HexSphereSceneController.*`
   - Отвечает за:
     - уровень разбиения (subdivision level);
     - модель планеты (`HexSphereModel`);
     - параметры генерации рельефа и биомов;
     - CPU-меши террейна, воды, контура выделения, пути;
     - список выделенных ячеек.
   - Предоставляет методы:
     - смена генератора рельефа;
     - перерасчёт рельефа;
     - построение полигона пути по выделенным ячейкам;
     - построение данных для рендера (позиции, индексы, владельцы треугольников и т.п.).

6. **Модель планеты и генерация рельефа**
   - Папка: `model/`
     - `HexSphereModel` — данные ячеек (центры, соседи, высоты, биомы).
   - Папка: `generation/`
     - интерфейс генераторов рельефа;
     - конкретные генераторы (плоский, синус, Перлин, климатический и др.);
     - генераторы мешей террейна, воды, wire-каркаса, контура выделения.

7. **Рендеринг**
   - Папка: `renderers/`
   - `HexSphereRenderer`:
     - владеет шейдерами и OpenGL-буферами;
     - имеет методы:
       - `initialize(...)` — создание ресурсов;
       - `uploadScene(...)` — загрузка планеты;
       - `uploadSelectionOutline(...)` — контур выделения;
       - `uploadPath(...)` — путь по поверхности;
       - `renderScene(...)` — отрисовка кадра.
   - Под-рендереры (terrain, water, entities, overlay) рисуют соответствующие части сцены.

8. **ECS (сущности и компоненты)**
   - Папка: `ECS/`
   - `ComponentStorage` — хранение сущностей и наборов компонентов:
     - `Transform` — позиция в мире;
     - `Mesh` — какой меш рисовать;
     - `Collider` — сфера для пика/столкновений;
     - другие компоненты по мере необходимости.
   - `InputController` создаёт сущности и управляет их жизненным циклом.
   - Рендерер рисует сущности, у которых есть нужные компоненты.

---

### 2. Где искать код для изменений

Для любой новой фичи можно пользоваться следующей картой:

- **Поведение при клике, движении мыши, нажатии клавиш**
  - `ui/HexSphereWidget.*` — вход Qt-событий;
  - `controllers/InputController.*` — вся логика реакции и изменение состояния.

- **Управление камерой (вращение, зум, FOV, луч под курсор)**
  - `controllers/CameraController.*`.

- **Логика планеты (сеточка, высоты, биомы, выделение, путь)**
  - `controllers/HexSphereSceneController.*`;
  - `model/HexSphereModel.*`;
  - `generation/*` — генераторы рельефа и мешей.

- **Внешний вид (цвета, шейдеры, стили линий, вода)**
  - `renderers/HexSphereRenderer.*` и под-рендереры;
  - шейдеры в ресурсах (папки с `.glsl` / `.vert` / `.frag`).

- **Объекты на планете (юниты, маркеры, башни и др.)**
  - `ECS/` — компоненты и хранение;
  - создание и управление сущностями — в `InputController::initialize` и связанных методах.

- **Панель настроек и связи между UI и логикой**
  - `ui/PlanetSettingsPanel.*` — виджет панели;
  - `ui/MainWindow.*` — соединение сигналов панели с методами `HexSphereWidget` / `InputController`.
